version: '3.9'

services:
    test-direct-client:
        image: node:16
        volumes:
            - ..:/repo
        networks:
            - test-servers
        working_dir: /repo/tests/test-client
        environment:
            - MOCHA_TESTS=src/direct.test.ts src/tls.test.ts src/socket.test.ts
        command: /bin/sh -c 'rm -rf /root/.npm && npm run test:watch'
    test-proxy-client:
        image: node:16
        volumes:
            - ..:/repo
        networks:
            - test-proxies
        working_dir: /repo/tests/test-client
        environment:
            - MOCHA_TESTS=src/proxy.test.ts
        command: /bin/sh -c 'rm -rf /root/.npm && npm run test:watch'
    test-http-proxy:
        image: ubuntu/squid:latest
        networks:
            - test-proxies
            - test-proxies-and-servers
        ports:
            - 3128
    test-http-auth-proxy:
        image: test-http-auth-proxy:latest
        build: test-http-auth-proxy
        networks:
            - test-proxies
            - test-proxies-and-servers
        ports:
            - 3128
    test-https-server:
        image: test-https-server:latest
        build: test-https-server
        volumes:
            - ./test-https-server:/etc/nginx
        networks:
            - test-servers
            - test-proxies-and-servers
        ports:
            - 443

networks:
    test-proxies: {}
    test-proxies-and-servers: {}
    test-servers: {}
